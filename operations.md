## Configuring GKE-Native Monitoring and Logging (remix)

### Overview

We're basically extending the standard lab with:
* An additional logging section
* A Google Cloud Managed Service for Prometheus section

### Task 0 - Starting the lab

1. Start the **Configuring GKE-Native Monitoring and Logging** lab in Qwiklabs
2. Perform the remaining steps in the **Lab Setup** section of the lab

### Task 1 - Using GKE

1. Perform **Task 1** in the lab instructions, but replace the command in Step 3
   with the following

    ``` bash
    gcloud container clusters create $my_cluster \
        --num-nodes 3 --enable-ip-alias --zone $my_zone  \
        --logging=SYSTEM,WORKLOAD,API_SERVER \
        --monitoring=SYSTEM,API_SERVER \
        --enable-managed-prometheus

> Note: This command is enabling optional logging and monitoring collection,
> and is enabling and installing the managed collector on your cluster.

It will take 5-7 minutes to create your cluster.

2. In the **Deploy a sample workload to your GKE cluster** section, verify that
    the appropriate **Logging** and **Monitoring** options are enabled, as well as the **Managed Service for Prometheus** option
2. Complete the rest of **Task 1** in the Qwiklabs instructions

### Task 2 - Using the test application

1. Perform **Task 2** as written

### Task 2b - Verifying that logging is working as intended

1. In the console, open **Cloud Logging**
2. Explore each of the Kubernetes and GKE related log sources.
    Investigate the types of log entries being reported in each
    source.
3. In the search field (which shows *Search all fields*), enter `this is a test` and click the **Run query** button. You should see entries generated by the test application.
4. Click on one of the entries generated by the test application.

    ```
    Question: What is the logname for this entry?
    Question: Which pod generated the message?
    Question: Which log source forwarded the event to Cloud Logging?
    ```

### Task 3 - Using Kubernetes Engine Monitoring

1. Do **Task 3** as written in Qwiklabs

### Task 3b - Managed Service for Prometheus

### Install a test application and configure workload monitoring

1. Review the deployment manifest for a third application you are going to deploy to the cluster by visiting [this Github link](https://raw.githubusercontent.com/GoogleCloudPlatform/prometheus-engine/v0.5.0/examples/example-app.yaml).

2. Use the following command to deploy the application:

    ```bash
    kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/prometheus-engine/v0.5.0/examples/example-app.yaml
    ```

3. Review the PodMonitoring manifest you will use to configure metrics collection with your application by visiting [this Github link](https://raw.githubusercontent.com/GoogleCloudPlatform/prometheus-engine/v0.5.0/examples/pod-monitoring.yaml). 

4. Use the following command to deploy the PodMonitoring resource to your cluster:

    ```bash
    kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/prometheus-engine/v0.5.0/examples/pod-monitoring.yaml
    ```

#### Explore the Managed Service for Prometheus components on cluster

5. In Cloud Shell, use the following command to display namespaces used by 
   Managed Service for Prometheus

    ``` bash
    kubectl get ns
    ```

    You should see two namespaces that start with gmp - this stands for Google 
    Managed Promethues

6. Use the following command to show GMP pods running:

    ``` bash
    kubectl -n gmp-system get pods
    ```

    You should see several components running, including the operator, the 
    collection agents, a rule evaluator, and an alert manager.

#### Review collected metrics

7.  In the Monitoring page of the console, go to 
    **Metrics explorer > Select Prometheus Target > Apiserver > 
    apiserver_adminssion...**

    This shows that API server metrics are being collected as expected.

8. View **Metrics explorer > Prometheus Target > Example > ... counter**
9.  You'll see a chart of the metrics reported by the test application
10. Click on **Code editor**
11. Look at the PromQL query - tools like Grafana can use this to pull
    metrics data out of Cloud Monitoring.

### Optional Task 4 - Creating alerts with Kubernetes Engine Monitoring

1. Do **Task 4** as written in Qwiklabs